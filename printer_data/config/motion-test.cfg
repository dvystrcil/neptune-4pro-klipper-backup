[gcode_macro AXIS_MOTION_TEST]
description: Test individual axis motion with configurable distance or full travel to endstop
gcode:
    {% set axis = params.AXIS|default('X')|upper %}
    {% set distance = params.DISTANCE|default(0)|float %}
    {% set use_endstop = params.USE_ENDSTOP|default(0)|int %}
    {% set speed_mms = params.SPEED|default(100)|int %}  # Input in mm/s
    {% set cycles = params.CYCLES|default(5)|int %}
    {% set mode = params.MODE|default('CONSTANT')|upper %}
    {% set min_speed_mms = params.MIN_SPEED|default(10)|int %}  # Input in mm/s
    {% set max_speed_mms = params.MAX_SPEED|default(500)|int %}  # Input in mm/s
    
    # Convert mm/s to mm/min for G-code
    {% set speed = (speed_mms * 60)|int %}
    {% set min_speed = (min_speed_mms * 60)|int %}
    {% set max_speed = (max_speed_mms * 60)|int %}
    
    # Validate axis parameter
    {% if axis not in ['X', 'Y', 'Z'] %}
        {action_respond_info("ERROR: AXIS must be X, Y, or Z")}
        {action_raise_error("Invalid axis specified")}
    {% endif %}
    
    # Validate mode parameter
    {% if mode not in ['CONSTANT', 'ACCELERATE', 'ACCEL'] %}
        {action_respond_info("ERROR: MODE must be CONSTANT or ACCELERATE")}
        {action_raise_error("Invalid mode specified")}
    {% endif %}
    
    # Normalize ACCEL to ACCELERATE
    {% if mode == 'ACCEL' %}
        {% set mode = 'ACCELERATE' %}
    {% endif %}
    
    # Get axis limits from printer config
    {% set axis_min = printer.toolhead.axis_minimum[axis|lower] %}
    {% set axis_max = printer.toolhead.axis_maximum[axis|lower] %}
    {% set axis_current = printer.toolhead.position[axis|lower] %}
    
    # Determine movement distance
    {% if use_endstop == 1 %}
        {% set move_distance = axis_max - 10 %}  # Move to near endstop, leaving 10mm margin
        {action_respond_info("Using endstop mode: moving to %s=%.1f" % (axis, move_distance))}
    {% elif distance > 0 %}
        {% set move_distance = distance %}
        {action_respond_info("Using custom distance: %.1fmm" % distance)}
    {% else %}
        {% set move_distance = (axis_max - axis_min) * 0.8 %}  # Default: 80% of travel
        {action_respond_info("Using default distance: %.1fmm (80%% of axis travel)" % move_distance)}
    {% endif %}
    
    # Safety check
    {% if move_distance > (axis_max - axis_min) %}
        {action_respond_info("WARNING: Distance exceeds axis travel, limiting to max")}
        {% set move_distance = axis_max - axis_min - 20 %}
    {% endif %}
    
    # Calculate start and end positions
    {% set start_pos = axis_min + 10 %}
    {% set end_pos = start_pos + move_distance %}
    
    {action_respond_info("==========================================")}
    {action_respond_info("AXIS MOTION TEST - %s AXIS" % axis)}
    {action_respond_info("==========================================")}
    {action_respond_info("Mode: %s" % mode)}
    {% if mode == 'CONSTANT' %}
        {action_respond_info("Speed: %d mm/s (%d mm/min)" % (speed_mms, speed))}
    {% else %}
        {action_respond_info("Speed Range: %d - %d mm/s (%d - %d mm/min)" % (min_speed_mms, max_speed_mms, min_speed, max_speed))}
    {% endif %}
    {action_respond_info("Cycles: %d" % cycles)}
    {action_respond_info("Start: %.1fmm" % start_pos)}
    {action_respond_info("End: %.1fmm" % end_pos)}
    {action_respond_info("Distance: %.1fmm" % move_distance)}
    {action_respond_info("==========================================")}
    
    # Calculate speed steps for accelerate mode
    {% if mode == 'ACCELERATE' %}
        {% set speed_increment = ((max_speed - min_speed) / (cycles - 1))|int if cycles > 1 else 0 %}
        {action_respond_info("Speed increment per cycle: %d mm/min (%.1f mm/s)" % (speed_increment, speed_increment / 60))}
    {% endif %}    
    # Home if not homed
    {% if printer.toolhead.homed_axes|lower != 'xyz' %}
        {action_respond_info("Homing all axes...")}
        G28
    {% endif %}
    
    # Move to safe Z height if testing X or Y
    {% if axis in ['X', 'Y'] %}
        G1 Z20 F3000
    {% endif %}
    
    # Move to starting position
    {action_respond_info("Moving to start position...")}
    M117 Test {axis}: Moving to start
    
    {% if axis == 'X' %}
        G1 X{start_pos} F{speed}
    {% elif axis == 'Y' %}
        G1 Y{start_pos} F{speed}
    {% elif axis == 'Z' %}
        G1 Z{start_pos} F{speed}
    {% endif %}
    
    G4 P500  # Pause 500ms
    
    # Run test cycles
    {% for i in range(cycles) %}
        # Calculate speed for this cycle
        {% if mode == 'CONSTANT' %}
            {% set current_speed = speed %}
        {% else %}
            {% set current_speed = (min_speed + (i * speed_increment))|int %}
        {% endif %}
        
        {action_respond_info("Cycle %d/%d - Speed: %d mm/s (%d mm/min)" % (i+1, cycles, current_speed / 60, current_speed))}
        M117 Test {axis}: {i+1}/{cycles} @ {current_speed / 60|round(1)}mm/s
        
        # Move forward
        {% if axis == 'X' %}
            G1 X{end_pos} F{current_speed}
        {% elif axis == 'Y' %}
            G1 Y{end_pos} F{current_speed}
        {% elif axis == 'Z' %}
            G1 Z{end_pos} F{current_speed}
        {% endif %}
        
        G4 P200  # Brief pause at end
        
        # Move back
        {% if axis == 'X' %}
            G1 X{start_pos} F{current_speed}
        {% elif axis == 'Y' %}
            G1 Y{start_pos} F{current_speed}
        {% elif axis == 'Z' %}
            G1 Z{start_pos} F{current_speed}
        {% endif %}
        
        G4 P200  # Brief pause at start
    {% endfor %}
    
    # Return to safe position
    {action_respond_info("Test complete, returning to safe position...")}
    M117 Test {axis}: Complete
    
    {% if axis == 'Z' %}
        G1 Z50 F3000
    {% else %}
        G1 X{(axis_max - axis_min) / 2} Y{(printer.toolhead.axis_maximum.y - printer.toolhead.axis_minimum.y) / 2} F{speed}
    {% endif %}
    
    {action_respond_info("==========================================")}
    {action_respond_info("MOTION TEST COMPLETE")}
    {action_respond_info("Check for:")}
    {action_respond_info("  - Smooth movement")}
    {action_respond_info("  - No grinding or binding")}
    {action_respond_info("  - No skipped steps")}
    {action_respond_info("  - Consistent speed")}
    {action_respond_info("==========================================")}
    M117 Motion test done


# Example usage macro for quick testing
[gcode_macro TEST_X]
description: Quick X axis test
gcode:
    AXIS_MOTION_TEST AXIS=X

[gcode_macro TEST_Y]
description: Quick Y axis test
gcode:
    AXIS_MOTION_TEST AXIS=Y

[gcode_macro TEST_Z]
description: Quick Z axis test
gcode:
    AXIS_MOTION_TEST AXIS=Z SPEED=50 CYCLES=3

[gcode_macro TEST_X_ACCEL]
description: Test X axis with accelerating speed
gcode:
    AXIS_MOTION_TEST AXIS=X MODE=ACCELERATE CYCLES=10

[gcode_macro TEST_Y_ACCEL]
description: Test Y axis with accelerating speed
gcode:
    AXIS_MOTION_TEST AXIS=Y MODE=ACCELERATE CYCLES=10

[gcode_macro TEST_X_FULL]
description: Test X axis full travel to endstop
gcode:
    AXIS_MOTION_TEST AXIS=X USE_ENDSTOP=1

[gcode_macro TEST_ALL_AXES]
description: Test all axes sequentially
gcode:
    {action_respond_info("Testing all axes sequentially...")}
    AXIS_MOTION_TEST AXIS=X CYCLES=3
    G4 P1000
    AXIS_MOTION_TEST AXIS=Y CYCLES=3
    G4 P1000
    AXIS_MOTION_TEST AXIS=Z CYCLES=3 SPEED=3000
    {action_respond_info("All axes tested!")}